#!/bin/bash
#
# Init repo's ci configuration with template, include Makefile, Dockfile and Jenkinsfile in devops directory

readonly REPO_NAME=$1
readonly REPO_TYPE=$2

err() {
  echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')]: $@" >&2
}

if [[ -z ${REPO_NAME} || -z ${REPO_TYPE} ]]; then
  err "Script execute failed. Usage: ./ci_init repo_name repo_type"
  exit -1
fi

#
# 初始化Makefile文件
#
sed "s/template_repo_name/${REPO_NAME}/g" Makefile.template > Makefile
if [ ${REPO_TYPE} == 'ts-frontend' ]; then
  sed -i "" "s/lint-template/npx lint-staged/" Makefile
  sed -i "" "s/test-template/npm run test:unit/" Makefile
elif [ ${REPO_TYPE} == 'python-backend' ]; then
  sed -i "" "s/lint-template/.git\/hooks\/pre-commit/" Makefile
  sed -i "" "s/test-template/python manage.py migrate \&\& python manage.py test siteapi.v1.tests/" Makefile
else
  err "Repo type not supported. Please use ts-frontend or python-backend."
  exit -1
fi

#
# 初始化Dockerfile文件
#
if [ ${REPO_TYPE} == 'ts-frontend' ]; then
  cp Dockerfile.frontend.template Dockerfile
elif [ ${REPO_TYPE} == 'python-backend' ]; then
  cp Dockerfile.backend.template Dockerfile
else
  err "Repo type not supported. Please use ts-frontend or python-backend."
  exit -1
fi